name: Manual Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      EC2_IP:
        description: "Enter EC2 IPv4 address"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create SSH key file
        run: |
          echo "Creating SSH key..."
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Deploy to EC2
        run: |
          HOST="${{ github.event.inputs.EC2_IP }}"
          echo "Connecting to EC2 at $HOST..."

          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ubuntu@$HOST "
            set -e
            echo '--- Connected to EC2 ---'

            if [ ! -d ~/crypto-analyst-ui ]; then
              git clone https://github.com/Mmarucr7/crypto-analyst-ui.git
            fi

            cd ~/crypto-analyst-ui

            echo '--- Pulling latest code ---'
            git pull

            echo '--- Installing dependencies ---'
            npm install

            echo '--- Building project ---'
            npm run build

            echo '--- Restarting PM2 ---'
            pm2 restart crypto-analyst-ui || pm2 start npm --name crypto-analyst-ui -- start

            echo '--- Deployment complete ---'
          "
